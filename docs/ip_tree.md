# IP и доменная схема

Этот файл описывает примерную схему распределения IP‑адресов и доменных имён для
инфраструктуры VPN‑сервиса.  Значения приведены для примера; замените их на
реальные адреса и домены перед развёртыванием.

## Узлы кластера

| Узел                | Внешний IP         | Роль                                  |
|---------------------|--------------------|---------------------------------------|
| `k8s-infra-1`       | 203.0.113.10       | Внутренняя инфраструктура (панели, UI, Grafana) |
| `k8s-traffic-1`     | 198.51.100.20      | VPN‑трафик (Xray/Marzban)             |
| `k8s-traffic-2`     | 198.51.100.21      | VPN‑трафик (Xray/Marzban)             |
| `k8s-ingress`       | 203.0.113.11       | Внешний IP балансировщика (MetalLB)   |

Примечание: в примере используется одна рабочая нода для внутренней части
инфраструктуры и две ноды для обслуживания VPN‑трафика.  Для отказоустойчивости
рекомендуется иметь как минимум две ноды в каждой группе.  Балансировщик (MetalLB
или аналогичный) выделяет отдельный IP для ingress‑контроллера.

## Соответствие IP и доменов

Дерево доменов и привязка к IP адресам может выглядеть так:

```
203.0.113.11  (Ingress IP)
└─ headlamp.example.com      → Service headlamp
└─ marzban.example.com       → Service marzban
└─ api.example.com           → Service vpn-backend
└─ sub.example.com           → Service subscription
└─ grafana.example.com       → Service grafana
└─ example.com               → Service vpn-frontend

198.51.100.20  (k8s-traffic-1)
└─ vpn-node-1.example.com    → Xray inbound (user traffic)

198.51.100.21  (k8s-traffic-2)
└─ vpn-node-2.example.com    → Xray inbound (user traffic)
```

## Рекомендуемое количество IP

* **1 IP для Ingress‑контроллера.**  Этот IP используется MetalLB (или
  облачным балансировщиком) для маршрутизации трафика к службам Headlamp,
  Marzban, API, подпискам и Grafana.  Все эти сервисы работают внутри кластера
  и разделяются по доменным именам через Ingress.

* **По одному IP на каждый VPN‑узел.**  В примере приведено два узла
  (`k8s-traffic-1` и `k8s-traffic-2`) с отдельными IP‑адресами.  Каждый IP
  используется в качестве точки входа для Xray‑туннелей.  Количество
  необходимых IP зависит от планируемой нагрузки и количества одновременно
  работающих инстансов Xray.  Рекомендуется приобрести минимум две адреса для
  балансировки нагрузки и отказоустойчивости.

* **Дополнительные IP (опционально).**  Если планируется разделять разные
  протоколы (например, Vmess, VLESS, Trojan) по отдельным IP‑адресам, то
  потребуется дополнительный пул адресов.

### Настройка DNS

Укажите в DNS‑зоне вашего домена A‑записи, указывающие на соответствующие IP.
Например:

```
headlamp           A    203.0.113.11
marzban            A    203.0.113.11
api                A    203.0.113.11
sub                A    203.0.113.11
grafana            A    203.0.113.11
@                  A    203.0.113.11
vpn-node-1         A    198.51.100.20
vpn-node-2         A    198.51.100.21
```

Перед запуском убедитесь, что все DNS‑записи указывают на корректные IP
адреса, а также что сертификаты Let’s Encrypt (или вашего CA) выпущены для
каждого домена.